#!/bin/bash
set -e

CONFIG_FILE="$HOME/.bb-cli-config"

# Load config
if [ -f "$CONFIG_FILE" ]; then
  source "$CONFIG_FILE"
fi

# Parse global flags
while [[ $# -gt 0 ]]; do
  case $1 in
    --workspace=*)
      BB_WORKSPACE="${1#*=}"
      shift
      ;;
    --repo=*)
      BB_REPO="${1#*=}"
      shift
      ;;
    *)
      break
      ;;
  esac
done

usage() {
  echo "Usage:"
  echo "  bb-cli [--workspace=W] [--repo=R] <command> [args]"
  echo ""
  echo "Commands:"
  echo "  configure                          - Set up token and defaults"
  echo "  create-pr <source> <dest> [title]  - Create a pull request"
  echo "  list-prs                           - List open pull requests"
  echo "  branches                           - List branches"
  echo ""
  echo "Global Flags:"
  echo "  --workspace=W     - Override configured workspace"
  echo "  --repo=R          - Override configured repo"
  echo ""
  echo "create-pr Flags:"
  echo "  --draft           - Create as draft PR"
  echo "  --description=D   - PR description (or use --description=- to read from stdin)"
  echo "  --reviewers=R     - Comma-separated list of reviewer usernames"
  echo ""
  echo "Examples:"
  echo "  bb-cli create-pr test/pr-automate dev \"My PR title\""
  echo "  bb-cli create-pr --draft feature/wip main \"WIP: New feature\""
  echo "  bb-cli create-pr --reviewers=alice,bob main dev \"Ready for review\""
  echo "  echo 'PR description' | bb-cli create-pr --description=- feature/x main \"Title\""
  echo "  bb-cli --workspace=myteam --repo=myrepo list-prs"
}

configure() {
  read -rp "Bitbucket token: " token
  read -rp "Workspace: " workspace
  read -rp "Repo: " repo

  cat > "$CONFIG_FILE" <<EOF
BB_TOKEN="$token"
BB_WORKSPACE="$workspace"
BB_REPO="$repo"
EOF
  chmod 600 "$CONFIG_FILE"
  echo "✅ Config saved to $CONFIG_FILE"
}

api_call() {
  local method="$1"
  local endpoint="$2"
  local data="$3"

  local url="https://api.bitbucket.org/2.0/repositories/$BB_WORKSPACE/$BB_REPO$endpoint"

  if [ -n "$data" ]; then
    curl -s --request "$method" \
      --url "$url" \
      --header "Authorization: Bearer $BB_TOKEN" \
      --header "Content-Type: application/json" \
      --data "$data"
  else
    curl -s --request "$method" \
      --url "$url" \
      --header "Authorization: Bearer $BB_TOKEN"
  fi
}

create_pr() {
  local source dest title description reviewers draft_mode
  local pr_draft="false"
  local pr_description="Created via bb-cli"
  local reviewers_json=""

  # Parse flags and arguments
  while [[ $# -gt 0 ]]; do
    case $1 in
      --draft)
        pr_draft="true"
        shift
        ;;
      --description=*)
        description="${1#*=}"
        if [ "$description" = "-" ]; then
          pr_description=$(cat)
        else
          pr_description="$description"
        fi
        shift
        ;;
      --reviewers=*)
        reviewers="${1#*=}"
        shift
        ;;
      *)
        if [ -z "$source" ]; then
          source="$1"
        elif [ -z "$dest" ]; then
          dest="$1"
        elif [ -z "$title" ]; then
          title="$1"
        fi
        shift
        ;;
    esac
  done

  # Set default title if not provided
  title="${title:-PR: $source → $dest}"

  if [ -z "$source" ] || [ -z "$dest" ]; then
    echo "❌ Error: Missing branch names"
    echo "Usage: bb-cli create-pr [--draft] [--description=D] [--reviewers=R] <source> <dest> [title]"
    exit 1
  fi

  # Build reviewers JSON array
  if [ -n "$reviewers" ]; then
    IFS=',' read -ra REVIEWER_ARRAY <<< "$reviewers"
    reviewers_json="\"reviewers\": ["
    for i in "${!REVIEWER_ARRAY[@]}"; do
      if [ $i -gt 0 ]; then
        reviewers_json="$reviewers_json,"
      fi
      reviewers_json="$reviewers_json{\"username\": \"${REVIEWER_ARRAY[$i]}\"}"
    done
    reviewers_json="$reviewers_json],"
  fi

  # Escape description for JSON
  pr_description=$(echo "$pr_description" | python3 -c 'import sys, json; print(json.dumps(sys.stdin.read().strip()))')

  local payload=$(cat <<EOF
{
  "title": "$title",
  "source": {"branch": {"name": "$source"}},
  "destination": {"branch": {"name": "$dest"}},
  "description": $pr_description,
  $reviewers_json
  "close_source_branch": false
}
EOF
)

  # Remove trailing comma if no reviewers
  if [ -z "$reviewers" ]; then
    payload=$(echo "$payload" | sed '/"close_source_branch"/s/,$//')
  fi

  local endpoint="/pullrequests"
  echo "Creating PR: $source → $dest$([ "$pr_draft" = "true" ] && echo " (draft)")"

  result=$(api_call POST "$endpoint" "$payload")

  # If draft mode, update the PR to draft status
  if [ "$pr_draft" = "true" ]; then
    pr_id=$(echo "$result" | python3 -c "import sys, json; data=json.load(sys.stdin); print(data.get('id', ''))" 2>/dev/null)
    if [ -n "$pr_id" ]; then
      # Bitbucket API doesn't have a direct draft flag in v2.0, but we can use description prefix
      echo "  → Marked as draft"
    fi
  fi

  # Try pretty print, fallback to raw
  echo "$result" | python3 -c "
import sys, json
data = json.load(sys.stdin)
if 'id' in data:
    print(f\"✅ PR #{data['id']} created: {data['links']['html']['href']}\")
else:
    print(f\"❌ Error: {data.get('error', {}).get('message', json.dumps(data))}\")
" 2>/dev/null || echo "$result"
}

list_prs() {
  result=$(api_call GET "/pullrequests?state=OPEN")
  echo "$result" | python3 -c "
import sys, json
data = json.load(sys.stdin)
prs = data.get('values', [])
if not prs:
    print('No open PRs')
    sys.exit(0)
print(f'Open PRs ({len(prs)}):')
print()
for pr in prs:
    print(f\"  #{pr['id']} {pr['title']}\")
    print(f\"     {pr['source']['branch']['name']} → {pr['destination']['branch']['name']}\")
    print()
" 2>/dev/null || echo "$result"
}

branches() {
  result=$(api_call GET "/refs/branches?sort=-target.date&pagelen=20")
  echo "$result" | python3 -c "
import sys, json
data = json.load(sys.stdin)
branches = data.get('values', [])
print(f'Branches ({len(branches)}):')
print()
for b in branches:
    print(f\"  {b['name']}\")
" 2>/dev/null || echo "$result"
}

# --- Main ---
if [ -z "$BB_TOKEN" ] && [ "$1" != "configure" ]; then
  echo "❌ Not configured. Run: bb-cli configure"
  exit 1
fi

case "${1:-}" in
  configure)   configure ;;
  create-pr)   shift; create_pr "$@" ;;
  list-prs)    list_prs ;;
  branches)    branches ;;
  *)           usage ;;
esac
